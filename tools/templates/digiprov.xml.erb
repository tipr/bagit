<?xml version="1.0" encoding="UTF-8"?>
<premis xmlns="http://www.loc.gov/standards/premis/v1" version="1.1">

<% require 'nokogiri'                                            %>
<%# hash of DAITSS event_codes and English translations:         %>
<%  daitss_events = {                                            %>
<%              :CPD => "Decrease preservation level",           %>
<%              :CPU => "Increase preservation level",           %>
<%              :CV  => "Virus check",                           %>
<%              :D   => "Disseminate",                           %>
<%              :DEL => "Deleted a previously ingested file",    %>
<%              :DLK => "Downloaded link",                       %>
<%              :FC  => "Fixity Check",                          %>
<%              :I   => "Ingest",                                %>
<%              :L   => "Localized",                             %>
<%              :M   => "Migrated",                              %>
<%              :N   => "Normalized",                            %>
<%              :RM  => "Refreshed media",                       %>
<%              :UNKNOWN => "Unknown event type",                %>
<%              :VC  => "Verify checksum",                       %>
<%              :WA  => "Withdraw by affiliate",                 %>
<%              :WO  => "Withdraw by operator"                   %>
<%                  }                                            %>
<%                                                               %>
<%# hash of roles for linked events                              %>
<%  daitss_roles = {                                             %>
<%              :DLK => "Local copy of linked file",             %>
<%              :L   => "Version of file with local links",      %>
<%              :M   => "Migrated file"                          %>
<%                  }                                            %>

<%# Our namespaces to retrieve information from our dip          %>
<%  xmlns = { "daitss" => "http://www.fcla.edu/dls/md/daitss/" } %>
    <!-- DAITSS events:  
<% event_array = daitss_events.map { |k, v| ["#{k}", v] } %>
<% event_array.sort.each do |a| %>
           <%= "#{a[0]}:" + " #{a[1]}" %>
<% end %>
     -->
  <object>
    <objectIdentifier>
      <objectIdentifierType>DAITSS</objectIdentifierType>
      <objectIdentifierValue>
        <!-- daitss:OID -->
<% if @events.empty? %>
        <%= @oid %>
<% else %>
        <%= @events.first.xpath("//daitss:OID", xmlns).first.content  %>
<% end %>
      </objectIdentifierValue>
    </objectIdentifier>
    <objectCategory>file</objectCategory>
  </object>
  
<%# Print out each event        %>
<% @events.each do |e|           %>
  <event>
  
    <!-- Converted from DAITSS schema -->
    <eventIdentifier>
      <eventIdentifierType>DAITSS</eventIdentifierType>
      <eventIdentifierValue>
        <!-- daitss:EVENT ID -->
        <%= e.xpath('./daitss:ID', xmlns).first.content %>
      </eventIdentifierValue>
    </eventIdentifier>
 
    <eventType>
      <!-- Nice description of DAITSS:EVENT_TYPE. See codes above. -->
      <%= daitss_events[:"#{e.xpath('./daitss:EVENT_TYPE', xmlns).first.content}"] %>
    </eventType>
 
    <eventDateTime>
      <!-- daitss:DATE_TIME in 8601 -->
      <%= Time.parse(e.xpath('./daitss:DATE_TIME', xmlns).first.content).xmlschema %>
    </eventDateTime>
 
    <eventDetail>
      <!-- daitss:EVENT_PROCEDURE -->
      <%= e.xpath('./daitss:EVENT_PROCEDURE', xmlns).first.content %>
    </eventDetail>
 
    <eventOutcomeInformation>
      <eventOutcome>
        <!-- daitss:OUTCOME -->
	<!-- fixme: should be a code? -->
        <%= e.xpath("./daitss:OUTCOME", xmlns).first.content %>
      </eventOutcome>
      <eventOutcomeDetail>
        <eventOutcomeDetailNote>
          <!-- daitss:NOTE -->
          <%= e.xpath("./daitss:NOTE", xmlns).first.content %>
        </eventOutcomeDetailNote>  
      </eventOutcomeDetail>
    </eventOutcomeInformation>

<% if not e.xpath("./daitss:REL_OID", xmlns).empty? %>
  <linkingObjectIdentifier>
    <linkingObjectIdentifierType>DAITSS</linkingObjectIdentifierType>
    <linkingObjectIdentifierValue>
      <!-- daitss:REL_OID -->
      <%= e.xpath("./daitss:REL_OID", xmlns).first.content %>
    </linkingObjectIdentifierValue>
<%# Only for premis v2:    <linkingObjectIdentifierRole>     %>
<%#                          <!-- A nice description of the related file's role %> 
<%#                               FIXME: check to make sure we address all potential relationships %>
<%#                          --> %>
<%#                          <%= daitss_roles[:"#{e.xpath('./daitss:EVENT_TYPE', xmlns).first.content}"] %>
<%#                        </linkingObjectIdentifierRole>   %>
  </linkingObjectIdentifier>
<% end %>  
  </event>
<% end %> 

</premis>
